// prisma/schema.prisma
// Bubble Bliss - NestJS + Prisma + MySQL (Hostinger compatible)
// Using default output (no custom path) for simplest setup.
// Run: npx prisma generate && npx prisma db push

generator client {
  provider = "prisma-client-js"
  // Default output: node_modules/@prisma/client
  // If you previously used a custom output, delete ./generated/prisma
  // and update imports to use `@prisma/client`.
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}
// ─────────────────────────────────────────────
// CATALOG
// ─────────────────────────────────────────────

model Category {
  id       Int       @id @default(autoincrement())
  slug     String    @unique @db.VarChar(60)  // "milk-tea", "shawarma", etc.
  name     String    @db.VarChar(100)
  sortOrder Int      @default(0)
  products Product[]

  @@map("categories")
}

model Product {
  id              Int       @id @default(autoincrement())
  slug            String    @unique @db.VarChar(150)
  name            String    @db.VarChar(120)
  description     String    @db.Text
  image           String?   @db.VarChar(255)
  isActive        Boolean   @default(true)
  inStock         Boolean   @default(true)
  priceInPesewas  Int?      // null for shawarma with variants; set for drinks
  sortOrder       Int       @default(0)

  categoryId  Int
  category    Category  @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  variants    ProductVariant[]
  orderItems  OrderItem[]

  @@map("products")
}

// Variants = size options (Medium/Large for shawarma).
// Drinks that have a single price get one default variant (key = "default").
model ProductVariant {
  id             Int     @id @default(autoincrement())
  productId      Int
  key            String  @db.VarChar(40)
  label          String  @db.VarChar(80)
  priceInPesewas Int
  sortOrder      Int     @default(0)

  product    Product      @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  orderItems OrderItem[]

  @@unique([productId, key])
  @@map("product_variants")
}

model Topping {
  id             Int     @id @default(autoincrement())
  name           String  @db.VarChar(100)
  priceInPesewas Int
  isActive       Boolean @default(true)
  inStock        Boolean @default(true)
  sortOrder      Int     @default(0)

  orderItemToppings OrderItemTopping[]

  @@map("toppings")
}

// ─────────────────────────────────────────────
// ORDERS
// ─────────────────────────────────────────────

// Use string constants instead of MySQL ENUMs for portability.
// Valid values documented in comments.

model Order {
  id                Int      @id @default(autoincrement())
  phone             String   @db.VarChar(30)
  locationText      String   @db.VarChar(255)
  notes             String?  @db.Text
  status            String   @default("pending") @db.VarChar(30)
  // paymentStatus: "unpaid" | "paid" | "failed"
  paymentStatus     String   @default("unpaid") @db.VarChar(20)
  totalPesewas      Int

  // Hubtel payment tracking
  clientReference   String   @unique @db.VarChar(32)
  hubtelCheckoutId  String?  @db.VarChar(64)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  items     OrderItem[]

  @@map("orders")
}

model OrderItem {
  id              Int     @id @default(autoincrement())
  orderId         Int
  productId       Int
  variantId       Int?

  productName     String  @db.VarChar(120)
  variantLabel    String? @db.VarChar(80)
  unitPesewas     Int
  quantity        Int     @default(1)

  sugarLevel  String? @db.VarChar(30)
  spiceLevel  String? @db.VarChar(30)
  note        String? @db.Text

  order    Order           @relation(fields: [orderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  product  Product         @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  variant  ProductVariant? @relation(fields: [variantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  toppings OrderItemTopping[]

  @@map("order_items")
}

model OrderItemTopping {
  id                   Int     @id @default(autoincrement())
  orderItemId          Int
  toppingId            Int
  toppingName          String  @db.VarChar(100)
  productImage         String? @db.VarChar(255)
  toppingBasePesewas   Int
  priceAppliedPesewas  Int

  orderItem  OrderItem @relation(fields: [orderItemId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  topping    Topping   @relation(fields: [toppingId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("order_item_toppings")
}

// ─────────────────────────────────────────────
// ADMIN USER
// ─────────────────────────────────────────────

model AdminUser {
  id           Int      @id @default(autoincrement())
  email        String   @unique @db.VarChar(150)
  passwordHash String   @db.VarChar(255)
  createdAt    DateTime @default(now())

  @@map("admin_users")
}
